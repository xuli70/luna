version: '3.8'

services:
  luna-app:
    image: node:22-alpine
    working_dir: /tmp/luna
    environment:
      - NODE_ENV=production
      - NPM_CONFIG_PRODUCTION=false
    command: >
      sh -c "
        echo 'ğŸ“¦ Instalando dependencias...' &&
        apk add --no-cache git nginx &&
        mkdir -p /tmp/luna &&
        cd /tmp/luna &&
        git clone https://github.com/xuli70/luna.git . &&
        npm install &&
        echo 'ğŸ”¨ Ejecutando build de producciÃ³n...' &&
        npm run build:prod &&
        echo 'âœ… Build completado exitosamente!' &&
        echo 'ğŸ“ Copiando archivos a nginx...' &&
        cp -r dist/* /usr/share/nginx/html/ &&
        echo 'ğŸ“ Verificando contenido...' &&
        ls -la /usr/share/nginx/html/ &&
        echo 'ğŸ”§ Configurando nginx para SPA...' &&
        echo 'server { listen 80; root /usr/share/nginx/html; index index.html; location / { try_files \\$uri \\$uri/ /index.html; } }' > /etc/nginx/http.d/default.conf &&
        echo 'ğŸŒ Iniciando nginx...' &&
        nginx -g 'daemon off;'
      "
    ports:
      - "3000:80"
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s