version: '3.8'

services:
  luna-app:
    image: node:22-alpine
    working_dir: /app
    environment:
      NODE_ENV: production
      NPM_CONFIG_PRODUCTION: "false"
    command: |
      sh -c "
        set -e

        echo 'ðŸ“¦ Instalando dependencias del sistema...' &&
        apk add --no-cache git nginx &&
        echo 'ðŸ“¦ Preparando directorio...' &&
        rm -rf /app/* /app/.* 2>/dev/null || true &&
        cd /app &&
        echo 'ðŸ“¦ Clonando repositorio...' &&
        git clone https://github.com/xuli70/luna.git . &&
        echo 'ðŸ“š Instalando dependencias npm...' &&
        npm install &&
        echo 'ðŸ”¨ Ejecutando build de producciÃ³n...' &&
        npm run build:prod &&
        echo 'âœ… Build completado exitosamente!' &&
        echo 'ðŸ“ Preparando directorio nginx...' &&
        rm -rf /var/lib/nginx/html/* &&
        mkdir -p /var/lib/nginx/html &&
        echo 'ðŸ“ Copiando archivos...' &&
        cp -r dist/* /var/lib/nginx/html/ &&
        echo 'ðŸ“ Verificando contenido...' &&
        ls -la /var/lib/nginx/html/ &&
        echo 'ðŸ”§ Configurando nginx...' &&
        mkdir -p /run/nginx &&
        cat > /etc/nginx/http.d/default.conf << 'NGINXCONF'
        server {
            listen 80;
            server_name _;
            root /var/lib/nginx/html;
            index index.html;

            location / {
                try_files $uri $uri/ /index.html;
            }

            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }
        NGINXCONF
        echo 'ðŸŒ Iniciando nginx...' &&
        nginx -g 'daemon off;'
      "
    ports:
      - "3000:80"
    restart: unless-stopped
